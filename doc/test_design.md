# テスト設計書

本プロジェクトにおけるテストの方針と、品質保証のための検証手順について記載します。

## 1. テスト方針
本アプリケーションは、**Unitテスト**（ロジック検証）と **E2Eテスト**（UI/統合検証）の2層で品質を保証します。
CI/CDパイプライン（GitHub Actions）により、コード変更時に自動的にこれらのテストが実行されます。

## 2. テスト環境

ディレクトリ構成:
- `tests/unit`: Unitテストコード
- `tests/e2e`: E2Eテストコード

### 2.1. Unitテスト環境
*   **対象**: `gacha-logic.js` (確率計算、昇格判定などのコアロジック)
*   **ツール**: **Jest**
*   **実行方法**:
    ```bash
    npm test
    ```
    ※ カバレッジレポートが自動的に生成されます。

### 2.2. E2Eテスト環境
*   **対象**: アプリケーション全体（フロントエンド + バックエンド連携）
*   **ツール**: **Playwright** (Node.js)
*   **実行環境**: Docker Compose によるローカルサーバー (`http://localhost:8000`)
*   **実行方法**:
    ```bash
    # アプリケーション起動
    cd docker && docker-compose up -d --build

    # テスト実行
    npm run test:e2e
    ```

**高速化・決定論的テスト**:
E2Eテストでは、以下の技術を用いて安定性と実行速度を向上させています。
- **API Mocking**: サーバーのレスポンスをモックし、遅延を排除するとともに、任意のガチャデータをテスト可能にします。
- **Animation Skipping**: `window.wait` 関数をオーバーライドし、演出待ち時間をスキップします。
- **Randomness Override**: `Math.random` をモックし、確率的な振る舞い（昇格など）を決定論的にテストします。
- **State Tracking Hooks**: `body` 要素の `data-gacha-status` 属性（`idle`, `shaking`, `result_shown` 等）を監視することで、アニメーションの進行状況に基づいた安定したキャプチャや検証を行います。

## 3. テストシナリオ

### 3.1. Unitテスト (Logic)
*   **重み付け抽選 (`drawItemByWeight`)**:
    *   重みに応じた確率でアイテムが選出されるか（`Math.random` モックを使用）。
    *   エッジケース（リストが空、重み合計が0など）の挙動。
*   **昇格判定 (`checkPromotion`)**:
    *   設定された確率以下で昇格が発生するか。
    *   確率以上で昇格しないか。

### 3.2. E2Eテスト (UI/Integration)
#### シナリオ: 標準的なガチャ実行フロー
1.  **初期表示**:
    *   **ロジックファイル読み込み確認**: `gacha-logic.js` が正常にロードされていること (Status 200)。
    *   タイトル「伝説の装備ガチャ」が表示される。
    *   ガチャマシン（SVG）がロードされ表示される。
    *   「ガチャを回す」ボタンが有効化される（データロード完了）。
2.  **実行**:
    *   ボタン押下後、ボタンが無効化される。
    *   マシンが揺れるアニメーション (`.animate-shake`) が発生する。
    *   （昇格時）マシーンのランプとエネルギー光が激しく点滅する。
3.  **結果表示**:
    *   一定時間後、結果画面が表示される。
    *   商品名、画像が表示される。
    *   「もう一度回す」ボタンが表示される。

### 3.3. セキュリティテスト (v3.0.1 追加)
アプリケーションの脆弱性を検証するためのテストケース。

#### テストケース: パストラバーサル (Server)
*   **検証内容**:
    *   `api/getGachaData` に対して `folder=../docker` 等のリクエストを送る。
    *   `api/getItemAsset` に対して `image=../../../etc/passwd` 等のリクエストを送る。
*   **期待結果**:
    *   サーバーはエラー（JSON形式または400/500系エラー）を返し、ファイルの生データを返却しないこと。
    *   コンソールログに不正アクセスが記録されること（オプション）。

#### テストケース: 静的ファイルアクセス制限 (Server)
*   **検証内容**:
    *   ブラウザから直接 `/docker/server.js` や `/package.json` にアクセスする。
*   **期待結果**:
    *   HTTP 404 Not Found が返却されること。

#### テストケース: XSS対策 (Client)
*   **検証内容**:
    *   `items.yaml` または Markdown 内に `<script>alert('XSS')</script>` を含むデータをモックとして注入する。
    *   ガチャ結果画面を表示する。
*   **期待結果**:
    *   アラートが表示されないこと。
    *   DOM上で `<script>` タグが除去またはエスケープされていること。

## 4. CI/CD (GitHub Actions)
以下のワークフローが定義されています (`.github/workflows/test.yml`)。

1.  **Unit Tests**: `npm test` を実行。
2.  **Docker Setup**: `docker-compose` でサーバーを起動。
3.  **E2E Tests**: `npm run test:e2e` を実行。
4.  **Artifacts**: テスト失敗時のスクリーンショットやカバレッジレポートを保存。
