# 仕様書: 子供向けお楽しみガチャアプリ

このドキュメントは、ガチャアプリの振る舞いとアーキテクチャを定義します。本アプリは、Docker コンテナ（Webサーバー）としての動作を主とし、Google Apps Script (GAS) としても動作可能なハイブリッド構成を採用しています。

## 用語定義
- **Client**: ブラウザ上の Web アプリ (HTML/JS)
- **Server (Container)**: Node.js (Express) サーバー。ローカルファイルシステムを参照する。
- **Server (GAS)**: Google Apps Script。Google Drive を参照する。
- **Data Source**: ガチャの設定ファイルと画像データ。
    - コンテナ環境: ローカルファイルシステム (`gacha_data/`)
    - GAS環境: Google Drive (`MyGachaApp/`)

---

# アーキテクチャ構成

## 1. コンテナ構成 (推奨)
Docker コンテナとして実行する場合の構成です。

- **Frontend**: `gacha.html` (静的ファイルとして配信)
- **Backend**: `docker/server.js` (Express)
- **Data**: ホストマシンの `gacha_data/` フォルダをコンテナにマウントして利用します。

## 2. GAS 構成 (Legacy/Sub)
Google Drive と連携して動作する場合の構成です。

- **Frontend**: `gacha.html` (HtmlService)
- **Backend**: `gacha.js` (GAS)
- **Data**: Google Drive 上の `MyGachaApp/` フォルダ

---

# 機能: アプリの初期表示
  ユーザーがアプリにアクセスした際、設定ファイルを読み込み、ガチャ画面を正しく描画する。

  シナリオ: 正常に設定ファイルを読み込んで起動する
    前提 データフォルダ (`gacha_data/gacha1` または Drive上の同等パス) に以下のファイルが存在する:
      | ファイル名    | 内容 |
      | items.yaml | ガチャのアイテムリストと重み付け定義 |
    
    もし ユーザーが Web アプリの URL にアクセスする
    ならば 画面タイトルに「お楽しみガチャ」と表示される
    かつ 中央に「ガチャマシン（SVGイラスト）」が表示される
    かつ 「ガチャを回す！」ボタンが有効化されている
    
  シナリオ: 設定ファイルが見つからない場合のエラーハンドリング
    もし ユーザーが Web アプリの URL にアクセスする
    かつ データファイルが存在しない、または読み込めない
    ならば アラートダイアログで「データの読み込みに失敗しました」と表示される
    かつ 「ガチャを回す！」ボタンは無効のままである

---

# 機能: ガチャを回す
  ユーザーのアクションに応じて抽選を行い、結果を表示する。

  背景:
    前提 アプリが起動し、items.yaml から以下のデータがロードされている:
      | id | name      | weight | image       | description |
      | 1  | 伝説の剣  | 10     | sword.png   | sword.md    |
      | 2  | 回復薬    | 90     | potion.png  | potion.md   |

  シナリオ: ガチャを実行し、結果を表示する
    もし ユーザーが「ガチャを回す！」ボタンをクリックする
    ならば ガチャマシンが振動アニメーション（shake）を開始する
    かつ 取り出し口から「カプセル」が出現し、手前に向かって回転しながら拡大移動する（約2秒）
    かつ 「ガチャを回す！」ボタンが無効化される
    かつ 画面に「カプセルを開けています...」と表示される
    
    もし 抽選処理（データ取得）が完了し、かつ カプセルの移動アニメーションも完了している
    ならば カプセルが非表示になる
    かつ 「ポンッ」という煙のエフェクトが表示される
    かつ 振動アニメーションが停止する
    かつ 結果表示エリアが表示される
    かつ 抽選されたアイテムの「名前」が表示される
    かつ 抽選されたアイテムの「画像」が表示される
    かつ 抽選されたアイテムの「説明文（Markdownレンダリング済み）」が表示される
    かつ ボタンのテキストが「もう一度回す」に変更され、有効化される

---

# 機能: データの取得と変換 (Backend API)
  環境に応じて適切なデータソースからデータを取得し、フロントエンドに返す。

  シナリオ: アイテムリストの取得 (getGachaData)
    もし API `getGachaData('gacha1')` が呼び出される
    ならば items.yaml のテキスト内容を含む JSON オブジェクト `{ success: true, yaml: "..." }` を返す

  シナリオ: アイテム詳細（画像・説明）の取得 (getItemAsset)
    前提 指定された画像ファイルとMarkdownファイルが存在する
    もし API `getItemAsset('gacha1', 'item1.png', 'item1.md')` が呼び出される
    ならば 以下のデータを含む JSON オブジェクトを返す:
      - success: true
      - imageData: Base64エンコードされた画像データ
      - mdContent: Markdownファイルのテキスト内容
