# 仕様書: 子供向けお楽しみガチャアプリ (v3.0)

このドキュメントは、Google Apps Script (GAS) と Google Drive を利用したガチャアプリの振る舞いを定義します。

## 用語定義
- **Client**: ブラウザ上の Web アプリ (HTML/JS)
- **Server**: Google Apps Script (GAS) または Dockerコンテナ内の Node.js サーバー
- **Drive**: Google Drive (データソース)

---

# 機能: データ構造とファイル構成
  アプリは Google Drive 上のフォルダ構造から設定とリソースを読み込む。

  仕様: ファイル構成
    各ガチャフォルダ（例: `gacha1/`）には以下の2つの設定ファイルが必須である。
    1. **`gacha.yaml`**: ガチャのメタデータ、グレード定義、昇格確率などの「ルール」を定義する。
    2. **`items.yaml`**: 排出されるアイテムのリストと、各アイテムの所属グレードを定義する。

---

# 機能: アプリの初期表示とデータ読み込み
  ユーザーがガチャ画面を開いた際、Server は指定されたガチャフォルダから設定をロードする。
  UIにはインラインSVGで描画されたガチャマシーンが表示される。

  シナリオ: 設定ファイルのロード (getGachaData)
    もし API `getGachaData('gacha1')` が呼び出される
    ならば Server は `gacha1` フォルダ内の `gacha.yaml` と `items.yaml` を読み込む
    かつ 以下の形式のオブジェクトを返す
    ```json
    {
      "success": true,
      "gachaYaml": "...(content of gacha.yaml)...",
      "itemsYaml": "...(content of items.yaml)..."
    }
    ```

    もし Client がレスポンスを受け取る
    ならば 2つの YAML をパースし、グレード設定とアイテムリストを結合して内部データベースを構築する

---

# 機能: ガチャ実行フロー (v3.2 Update)
  ユーザー操作とアニメーションの連携フロー。

  **Phase 1: 抽選アクション**
  1. **ノブ回転**: ユーザーがノブをクリックすると、ノブが回転し、マシーン本体が振動する。
  2. **エネルギー充填**: 内部の光 (`#energy-glow`) が明滅する。

  **Phase 2: カプセル排出**
  1. **出現**: 排出口 (`#exit-hole`) から新しいカプセルが生成される。
  2. **転がり演出**: カプセルが回転しながら画面中央手前へ拡大移動する。

  **Phase 3: 開封と昇格判定**
  1. **待機**: カプセルが中央で停止し、ユーザーのクリックを待つ。
  2. **開封アクション**:
     * **通常時**: クリックするとカプセルが開き、アイテムが表示される。
     * **昇格時**:
       1. クリック後、カプセルが開かずに振動する。
       2. カプセルにひび割れエフェクトが入り、光が漏れる。
       3. 効果音と共にカプセル色が変化し（例: 青→金）、背景が豪華なエフェクトに切り替わる。
       4. **連鎖昇格判定**: 色変化後、さらに上位グレードへの昇格判定を行い、当選すれば 1〜3 を繰り返す（例: 青→金→虹）。
       5. 最終的なグレードのカプセルが開き、アイテムが表示される。

---

# 機能: ガチャ抽選ロジック
  `gacha.yaml` で定義された確率設定に基づき、抽選と昇格判定を行う。

  シナリオ: 内部抽選処理
    もし ユーザーがガチャを回す
    ならば `items.yaml` の `weight` に基づいて初期アイテムとグレードを決定する (例: "G1")

    Phase 3 (開封アクション) において、以下のループを実行する:
    1. 現在のグレードの `promotion` 設定を確認する。
    2. 確率に基づいて昇格判定を行う。
    3. **当選時**: 昇格演出を実行し、グレードを更新してループを継続する。
    4. **ハズレ時**: フェイク昇格判定を行う。フェイク当選時は演出のみ実行してループ終了。
    5. **ハズレかつフェイクなし**: ループ終了し、開封する。

    最終的に確定したグレードに基づいて、再度アイテムを抽選しなおす（または初期アイテムが同一グレードなら維持）。

---

# 機能: ガチャ演出
  `gacha.yaml` の `color` 定義とグレードに基づいて演出を行う。

  仕様: マシーン内部のカプセル表示
    ガチャマシーンのドーム内には、常に複数のカプセルが表示されていること。
    これらのカプセルはSVGアセット内であらかじめカラフルに定義されており、アプリ側での動的なリフレッシュ処理は行わない。

---

# エンジニアへの補足
*   **GAS / Node.js 両対応**: `getGachaData` はGAS環境とローカルNode.js環境の両方で同じインターフェースを維持すること。
*   **非同期処理**: 演出のアニメーションとデータフェッチのタイミング制御に注意すること（Promise制御）。

# 機能: セキュリティ (v3.0.1 追加)
  アプリケーションの堅牢性を高めるため、以下のセキュリティ対策を実施する。

  仕様: パストラバーサル対策 (Server)
    Server は `getGachaData` および `getItemAsset` API において、リクエストされたファイルパスを検証しなければならない。

    もし パラメータ（`folder`, `image` 等）に親ディレクトリへの移動（`..`）が含まれている、または `DATA_ROOT` 外へのアクセスを試みる場合
    ならば Server はエラーを返し、ファイルの内容を返却してはならない。

  仕様: 静的ファイルのアクセス制限 (Server)
    Server は、`gacha_data/` 以下のリソースと、アプリの動作に必要な最小限のJSファイルのみを公開する。
    サーバーのソースコード (`server.js`) や設定ファイル (`package.json`) への直接アクセスは禁止（404 Not Found）とする。

  仕様: XSS (クロスサイトスクリプティング) 対策 (Client)
    Client は、Markdown から変換された HTML を表示する際、必ずサニタイズ処理を行わなければならない。

    もし `items.yaml` や Markdown ファイル内に `<script>` タグなどの悪意あるコードが含まれていても
    ならば `DOMPurify` 等を使用してそれらを無害化し、スクリプトが実行されないようにする。

# 機能: ドキュメント生成
  開発プロセスの一環として、README等に使用するデモ素材（GIFアニメーション）を自動生成する。

  仕様: GIFアニメーション生成
    E2Eテストフレームワーク (Playwright) を利用して、ブラウザ上のガチャ演出を録画し、GIF形式で保存するスクリプトを用意する。
    `npm run generate-gif` コマンドにより、`doc/gacha_demo.gif` を再生成可能とする。
