# 仕様書: 子供向けお楽しみガチャアプリ (v3.0)

このドキュメントは、Google Apps Script (GAS) と Google Drive を利用したガチャアプリの振る舞いを定義します。

## 用語定義
- **Client**: ブラウザ上の Web アプリ (HTML/JS)
- **Server**: Google Apps Script (GAS) または Dockerコンテナ内の Node.js サーバー
- **Drive**: Google Drive (データソース)

---

# 機能: データ構造とファイル構成
  アプリは Google Drive 上のフォルダ構造から設定とリソースを読み込む。

  仕様: ファイル構成
    各ガチャフォルダ（例: `gacha1/`）には以下の2つの設定ファイルが必須である。
    1. **`gacha.yaml`**: ガチャのメタデータ、グレード定義、昇格確率などの「ルール」を定義する。
    2. **`items.yaml`**: 排出されるアイテムのリストと、各アイテムの所属グレードを定義する。

---

# 機能: アプリの初期表示とデータ読み込み
  ユーザーがガチャ画面を開いた際、Server は指定されたガチャフォルダから設定をロードする。

  シナリオ: 設定ファイルのロード (getGachaData)
    もし API `getGachaData('gacha1')` が呼び出される
    ならば Server は `gacha1` フォルダ内の `gacha.yaml` と `items.yaml` を読み込む
    かつ 以下の形式のオブジェクトを返す
    ```json
    {
      "success": true,
      "gachaYaml": "...(content of gacha.yaml)...",
      "itemsYaml": "...(content of items.yaml)..."
    }
    ```

    もし Client がレスポンスを受け取る
    ならば 2つの YAML をパースし、グレード設定とアイテムリストを結合して内部データベースを構築する

---

# 機能: ガチャ抽選ロジック (連鎖昇格)
  `gacha.yaml` で定義された確率設定に基づき、抽選と昇格判定を行う。

  シナリオ: 抽選実行フロー
    前提 `gacha.yaml` にグレードごとの `promotion` (next_grade, rate) が定義されている
    
    もし ユーザーがガチャを回す
    # 1. 基礎抽選
    ならば `items.yaml` の `weight` に基づいてアイテムを一つ仮決定する
    かつ そのアイテムの `grade` を取得する (例: "G1")
    
    # 2. 連鎖昇格ループ (演出と同期)
    ループ開始:
      現在のグレードに対応する演出（カプセル排出）を実行する

      もし 現在のグレードに `promotion` 設定が存在する
      ならば `rate` (確率) に基づいて昇格判定を行う

      もし 昇格に当選した場合
      ならば 「昇格演出」を表示する
      かつ グレードを `next_grade` (例: "G2") に変更する
      かつ ループの先頭に戻り、新しいグレードで演出をやり直す

      もし 昇格しなかった場合
      ならば フェイク昇格判定 (`fake_rate`) を行う

      もし フェイク昇格に当選した場合
      ならば 「昇格演出」を表示する（ただしカプセル色は変化せず、グレードも維持する）
      かつ ループを終了し、結果表示へ進む

      もし フェイク昇格もしなかった場合
      ならば ループを終了し、結果表示へ進む

    # 3. アイテム再抽選
    もし 最終的なグレードが確定した (例: G1 -> G3 に昇格)
    ならば `items.yaml` の中から、その確定グレード("G3")に属するアイテムを `weight` に基づいてランダムに再選出する
    かつ そのアイテムを最終排出結果とする

---

# 機能: ガチャ演出
  `gacha.yaml` の `color` 定義とグレードに基づいて演出を行う。
  カプセル色などをハードコーディングせず、YAMLの設定値を使用する。

  仕様: マシーン内部のカプセル表示
    ガチャマシーンのドーム内には、常に複数のカプセルが表示されていること。
    これらのカプセルは単色ではなく、ランダムな色（赤、青、黄、緑、紫、オレンジ、水色など）で塗り分けられ、カラフルな見た目を維持する。
    アプリ起動時およびガチャ実行時に、これらのカプセルの配置や色がリフレッシュされることが望ましい。

  シナリオ: 動的な演出設定 (ループ演出)
    もし 抽選結果（初期）が "G1" (blue) であり、後に "G2" (red) に昇格する場合
    
    1. マシーンが揺れ、青いカプセル ("blue") が排出される
    2. カプセルが開く直前に「昇格」エフェクトが発生する
       * マシーンのランプとエネルギー光が激しく点滅する
    3. カプセルが消え（リセット）、再びマシーンが揺れ始める
    4. 今度は赤いカプセル ("red") が排出される
    5. (これ以上昇格しない場合) カプセルが開き、アイテムが表示される

---

# エンジニアへの補足
*   **GAS / Node.js 両対応**: `getGachaData` はGAS環境とローカルNode.js環境の両方で同じインターフェースを維持すること。
*   **非同期処理**: 演出のアニメーションとデータフェッチのタイミング制御に注意すること（Promise制御）。

# 機能: セキュリティ (v3.0.1 追加)
  アプリケーションの堅牢性を高めるため、以下のセキュリティ対策を実施する。

  仕様: パストラバーサル対策 (Server)
    Server は `getGachaData` および `getItemAsset` API において、リクエストされたファイルパスを検証しなければならない。

    もし パラメータ（`folder`, `image` 等）に親ディレクトリへの移動（`..`）が含まれている、または `DATA_ROOT` 外へのアクセスを試みる場合
    ならば Server はエラーを返し、ファイルの内容を返却してはならない。

  仕様: 静的ファイルのアクセス制限 (Server)
    Server は、`gacha_data/` 以下のリソースと、アプリの動作に必要な最小限のJSファイルのみを公開する。
    サーバーのソースコード (`server.js`) や設定ファイル (`package.json`) への直接アクセスは禁止（404 Not Found）とする。

  仕様: XSS (クロスサイトスクリプティング) 対策 (Client)
    Client は、Markdown から変換された HTML を表示する際、必ずサニタイズ処理を行わなければならない。

    もし `items.yaml` や Markdown ファイル内に `<script>` タグなどの悪意あるコードが含まれていても
    ならば `DOMPurify` 等を使用してそれらを無害化し、スクリプトが実行されないようにする。

# 機能: ドキュメント生成
  開発プロセスの一環として、README等に使用するデモ素材（GIFアニメーション）を自動生成する。

  仕様: GIFアニメーション生成
    E2Eテストフレームワーク (Playwright) を利用して、ブラウザ上のガチャ演出を録画し、GIF形式で保存するスクリプトを用意する。
    `npm run generate-gif` コマンドにより、`doc/gacha_demo.gif` を再生成可能とする。
