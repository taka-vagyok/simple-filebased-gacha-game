<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <base target="_top">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="gacha-logic.js"></script>
    
    <style>
      body {
        font-family: "Noto Sans CJK JP", "IPAGothic", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      }
      /* ガチャ演出用CSS */
      @keyframes shake {
        0% { transform: rotate(0deg); }
        25% { transform: rotate(2deg); }
        50% { transform: rotate(0deg); }
        75% { transform: rotate(-2deg); }
        100% { transform: rotate(0deg); }
      }
      .animate-shake { animation: shake 0.1s infinite; }

      @keyframes spin-handle {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .animate-spin-handle {
        transform-origin: 200px 380px;
        animation: spin-handle 1s ease-in-out;
      }
      
      .capsule-container {
        position: absolute;
        top: 70%; /* Adjust based on exit position */
        left: 50%;
        transform: translate(-50%, -50%) scale(0.1);
        opacity: 0;
        transition: all 2s ease-out;
        z-index: 10;
        pointer-events: none;
      }

      .capsule-appear {
        opacity: 1;
        top: 50%;
        transform: translate(-50%, -50%) scale(1.5) rotate(720deg);
      }

      @keyframes smoke {
        0% { opacity: 0; transform: scale(0.5); }
        20% { opacity: 1; transform: scale(1.2); }
        100% { opacity: 0; transform: scale(1.5); }
      }
      .smoke-pop {
        animation: smoke 0.5s ease-out forwards;
      }
    </style>
  </head>
  <body class="bg-yellow-50 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Definitions for SVG Gradients -->
    <svg width="0" height="0" class="absolute">
      <defs>
        <linearGradient id="rainbowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color:#ff0000;stop-opacity:1" />
          <stop offset="16%" style="stop-color:#ff7f00;stop-opacity:1" />
          <stop offset="33%" style="stop-color:#ffff00;stop-opacity:1" />
          <stop offset="50%" style="stop-color:#00ff00;stop-opacity:1" />
          <stop offset="66%" style="stop-color:#0000ff;stop-opacity:1" />
          <stop offset="83%" style="stop-color:#4b0082;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#9400d3;stop-opacity:1" />
        </linearGradient>
      </defs>
    </svg>

    <div id="app" class="max-w-md w-full bg-white rounded-xl shadow-lg overflow-hidden p-6 text-center relative">
      <h1 class="text-2xl font-bold text-gray-800 mb-6">お楽しみガチャ</h1>

      <!-- ガチャマシーンエリア -->
      <div class="relative w-full max-w-[300px] mx-auto mb-8 aspect-[2/3]">
        <!-- Machine Container -->
        <div id="machine-container" class="w-full h-full drop-shadow-xl">
           <!-- SVG will be injected here -->
           <div class="flex items-center justify-center h-full text-gray-400">Loading Machine...</div>
        </div>

        <!-- Hidden Capsule (Animated) -->
        <div id="capsule" class="capsule-container w-24 h-24">
           <!-- SVG will be injected here -->
        </div>

        <!-- Smoke Effect (Hidden) -->
        <div id="smoke" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-48 pointer-events-none opacity-0">
          <svg viewBox="0 0 100 100" fill="#e5e7eb">
            <circle cx="50" cy="50" r="20" />
            <circle cx="30" cy="40" r="15" />
            <circle cx="70" cy="40" r="15" />
            <circle cx="40" cy="70" r="12" />
            <circle cx="60" cy="70" r="12" />
            <circle cx="50" cy="20" r="10" />
          </svg>
        </div>
      </div>

      <button id="btn-pull" onclick="pullGacha()" disabled class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-full shadow-lg transition transform active:scale-95 disabled:opacity-50">
        ガチャを回す！
      </button>

      <div id="result-area" class="hidden mt-6 border-t pt-6">
        <div id="loading" class="hidden text-gray-500">カプセルを開けています...</div>
        
        <div id="result-content" class="hidden">
          <h2 id="item-name" class="text-xl font-bold text-purple-600 mb-2"></h2>
          <img id="item-img" class="w-full h-48 object-contain mb-4 rounded-md bg-gray-100" />
          <div id="item-desc" class="text-left text-gray-700 text-sm bg-gray-50 p-3 rounded markdown-body"></div>
        </div>
      </div>
    </div>

    <script>
      let gachaItems = [];
      let gachaConfig = {}; // gacha.yaml data
      const GACHA_FOLDER = 'gacha1';
      let capsuleTemplate = '';

      // 色マッピング (CSS色名やHex)
      const COLOR_MAP = {
          "blue": "#448AFF",
          "red": "#FF5252",
          "silver": "#C0C0C0",
          "gold": "#FFD700",
          "rainbow": "url(#rainbowGradient)", // SVG defs needed or handled specially
          "green": "#66BB6A",
          "purple": "#AB47BC"
      };

      const isGasEnvironment = (typeof google !== 'undefined' && google.script && google.script.run);

      const backend = isGasEnvironment ? google.script.run : {
        withSuccessHandler: function(success) {
            const runner = Object.create(this);
            runner._success = success;
            return runner;
        },
        withFailureHandler: function(failure) {
            const runner = Object.create(this);
            runner._failure = failure;
            return runner;
        },
        getGachaData: function(folder) {
            fetch(`/api/getGachaData?folder=${folder}`)
                .then(r => r.json())
                .then(data => this._success && this._success(data))
                .catch(err => this._failure && this._failure(err));
        },
        getItemAsset: function(folder, img, desc) {
            fetch(`/api/getItemAsset?folder=${folder}&image=${img}&description=${desc}`)
                .then(r => r.json())
                .then(data => this._success && this._success(data))
                .catch(err => this._failure && this._failure(err));
        },
        getCommonAsset: function(filename) {
            fetch(`gacha_data/${filename}`)
                .then(r => {
                    if (!r.ok) throw new Error('File not found');
                    return r.text();
                })
                .then(text => this._success && this._success({ success: true, content: text }))
                .catch(err => this._failure && this._failure(err));
        }
      };

      window.onload = () => {
        loadResources();
      };

      function loadResources() {
          backend
            .withSuccessHandler(onDataLoaded)
            .withFailureHandler(onError)
            .getGachaData(GACHA_FOLDER);

          backend
            .withSuccessHandler((res) => {
                if(res.success) {
                    document.getElementById('machine-container').innerHTML = res.content;
                    const svg = document.querySelector('#machine-container svg');
                    if(svg) {
                        svg.id = 'machine';
                        svg.classList.add('w-full', 'h-full');
                    }
                }
            })
            .getCommonAsset('machine.svg');

          backend
            .withSuccessHandler((res) => {
                if(res.success) {
                    capsuleTemplate = res.content;
                    document.getElementById('capsule').innerHTML = capsuleTemplate;
                }
            })
            .getCommonAsset('capsule.svg');
      }

      function onDataLoaded(res) {
        if (res.success) {
          gachaConfig = jsyaml.load(res.gachaYaml);
          gachaItems = jsyaml.load(res.itemsYaml);
          console.log("Loaded Config:", gachaConfig);
          console.log("Loaded Items:", gachaItems);

          if (gachaConfig.name) {
              document.querySelector('h1').innerText = gachaConfig.name;
          }

          document.getElementById('btn-pull').disabled = false;
        } else {
          alert(`データの読み込みに失敗しました: ${res.error}`);
        }
      }

      async function pullGacha() {
        if (gachaItems.length === 0) return;

        const btn = document.getElementById('btn-pull');
        const smoke = document.getElementById('smoke');
        
        btn.disabled = true;
        document.getElementById('result-area').classList.remove('hidden');
        document.getElementById('result-content').classList.add('hidden');
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('loading').innerText = "抽選中...";
        smoke.classList.remove('smoke-pop');

        try {
            // 1. Initial Draw (Weighted)
            const tempItem = GachaLogic.drawItemByWeight(gachaItems);
            let currentGradeKey = tempItem.grade;

            // Loop for promotion
            while (true) {
                const gradeConfig = gachaConfig.grades[currentGradeKey];
                console.log("Current Grade:", currentGradeKey);

                // Play Animation for this grade
                await playCapsuleAnimation(gradeConfig.color);

                // Check Promotion
                const nextGradeKey = GachaLogic.checkPromotion(gradeConfig);

                if (nextGradeKey) {
                    // Promotion!
                    await showPromotionEffect();
                    currentGradeKey = nextGradeKey;
                    // Loop continues
                } else {
                    // Check Fake Promotion
                    if (GachaLogic.checkFakePromotion(gradeConfig)) {
                        console.log("Fake Promotion Triggered!");
                        await showPromotionEffect();
                        // Do NOT update currentGradeKey
                    }
                    // Finalize
                    break;
                }
            }

            // 2. Final Re-draw based on final grade
            const validItems = gachaItems.filter(i => i.grade === currentGradeKey);
            let finalItem;
            if (validItems.length > 0) {
                finalItem = GachaLogic.drawItemByWeight(validItems);
            } else {
                console.error("No items found for grade:", currentGradeKey);
                finalItem = tempItem; // Fallback
            }

            // 3. Fetch Asset & Show Result
            document.getElementById('loading').innerText = "アイテム取得中...";
            const assets = await fetchItemAsset(finalItem);
            showResult(finalItem, assets);

        } catch (e) {
            onError(e);
        }
      }

      async function playCapsuleAnimation(colorName) {
        const machine = document.getElementById('machine');
        const capsuleContainer = document.getElementById('capsule');
        const colorHex = COLOR_MAP[colorName] || colorName;

        // Reset
        capsuleContainer.classList.remove('capsule-appear');
        capsuleContainer.style.opacity = '0';

        // Update Color
        if (capsuleTemplate) {
            capsuleContainer.innerHTML = capsuleTemplate;
            const capsuleColorEl = capsuleContainer.querySelector('.capsule-color');
            if(capsuleColorEl) {
                capsuleColorEl.setAttribute('fill', colorHex);
            }
        }

        // Machine Shake
        if(machine) {
            machine.classList.add('animate-shake');
            const handle = machine.querySelector('#machine-handle');
            if(handle) {
                handle.classList.remove('animate-spin-handle');
                void handle.offsetWidth;
                handle.classList.add('animate-spin-handle');
            }
        }

        // Wait a bit for shake
        await wait(500);

        // Capsule Appear
        if(machine) machine.classList.remove('animate-shake');
        capsuleContainer.classList.add('capsule-appear');

        // Wait for appear animation
        await wait(1500);
      }

      async function showPromotionEffect() {
          const loading = document.getElementById('loading');
          const originalText = loading.innerText;
          loading.innerText = "昇格チャンス！";
          loading.classList.add('text-red-500', 'font-bold', 'text-xl');

          const smoke = document.getElementById('smoke');
          smoke.classList.add('smoke-pop'); // Smoke

          await wait(1000); // Pause to see smoke/effect

          smoke.classList.remove('smoke-pop');
          loading.innerText = originalText;
          loading.classList.remove('text-red-500', 'font-bold', 'text-xl');
      }

      function wait(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
      }

      function fetchItemAsset(item) {
          return new Promise((resolve, reject) => {
             backend
              .withSuccessHandler((assets) => resolve(assets))
              .withFailureHandler((err) => reject(err))
              .getItemAsset(GACHA_FOLDER, item.image, item.description);
          });
      }

      function showResult(item, assets) {
        document.getElementById('loading').classList.add('hidden');
        
        if (assets.success) {
          const content = document.getElementById('result-content');
          content.classList.remove('hidden');

          document.getElementById('item-name').innerText = item.name;
          document.getElementById('item-img').src = assets.imageData;
          // markedを使ってMarkdownをHTMLに変換
          document.getElementById('item-desc').innerHTML = marked.parse(assets.mdContent);
        } else {
          alert('景品の取得に失敗しました');
        }
        
        const btn = document.getElementById('btn-pull');
        btn.disabled = false;
        btn.innerText = "もう一度回す";
      }

      function onError(e) {
        alert(`エラーが発生しました: ${e}`);
        document.getElementById('btn-pull').disabled = false;
        const machine = document.getElementById('machine');
        if(machine) machine.classList.remove('animate-shake');
        document.getElementById('capsule').classList.remove('capsule-appear');
      }
    </script>
  </body>
</html>
