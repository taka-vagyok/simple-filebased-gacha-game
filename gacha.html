<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <base target="_top">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
      body {
        font-family: "Noto Sans CJK JP", "IPAGothic", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      }
      /* ガチャ演出用CSS */
      @keyframes shake {
        0% { transform: rotate(0deg); }
        25% { transform: rotate(2deg); }
        50% { transform: rotate(0deg); }
        75% { transform: rotate(-2deg); }
        100% { transform: rotate(0deg); }
      }
      .animate-shake { animation: shake 0.1s infinite; }

      @keyframes spin-handle {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .animate-spin-handle {
        transform-origin: 200px 380px;
        animation: spin-handle 1s ease-in-out;
      }
      
      .capsule-container {
        position: absolute;
        top: 70%; /* Adjust based on exit position */
        left: 50%;
        transform: translate(-50%, -50%) scale(0.1);
        opacity: 0;
        transition: all 2s ease-out;
        z-index: 10;
        pointer-events: none;
      }

      .capsule-appear {
        opacity: 1;
        top: 50%;
        transform: translate(-50%, -50%) scale(1.5) rotate(720deg);
      }

      @keyframes smoke {
        0% { opacity: 0; transform: scale(0.5); }
        20% { opacity: 1; transform: scale(1.2); }
        100% { opacity: 0; transform: scale(1.5); }
      }
      .smoke-pop {
        animation: smoke 0.5s ease-out forwards;
      }
    </style>
  </head>
  <body class="bg-yellow-50 min-h-screen flex flex-col items-center justify-center p-4">

    <div id="app" class="max-w-md w-full bg-white rounded-xl shadow-lg overflow-hidden p-6 text-center relative">
      <h1 class="text-2xl font-bold text-gray-800 mb-6">お楽しみガチャ</h1>

      <!-- ガチャマシーンエリア -->
      <div class="relative w-full max-w-[300px] mx-auto mb-8 aspect-[2/3]">
        <!-- Machine Container -->
        <div id="machine-container" class="w-full h-full drop-shadow-xl">
           <!-- SVG will be injected here -->
           <div class="flex items-center justify-center h-full text-gray-400">Loading Machine...</div>
        </div>

        <!-- Hidden Capsule (Animated) -->
        <div id="capsule" class="capsule-container w-24 h-24">
           <!-- SVG will be injected here -->
        </div>

        <!-- Smoke Effect (Hidden) -->
        <div id="smoke" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-48 pointer-events-none opacity-0">
          <svg viewBox="0 0 100 100" fill="#e5e7eb">
            <circle cx="50" cy="50" r="20" />
            <circle cx="30" cy="40" r="15" />
            <circle cx="70" cy="40" r="15" />
            <circle cx="40" cy="70" r="12" />
            <circle cx="60" cy="70" r="12" />
            <circle cx="50" cy="20" r="10" />
          </svg>
        </div>
      </div>

      <button id="btn-pull" onclick="pullGacha()" disabled class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-full shadow-lg transition transform active:scale-95 disabled:opacity-50">
        ガチャを回す！
      </button>

      <div id="result-area" class="hidden mt-6 border-t pt-6">
        <div id="loading" class="hidden text-gray-500">カプセルを開けています...</div>
        
        <div id="result-content" class="hidden">
          <h2 id="item-name" class="text-xl font-bold text-purple-600 mb-2"></h2>
          <img id="item-img" class="w-full h-48 object-contain mb-4 rounded-md bg-gray-100" />
          <div id="item-desc" class="text-left text-gray-700 text-sm bg-gray-50 p-3 rounded markdown-body"></div>
        </div>
      </div>
    </div>

    <script>
      let gachaItems = []; // YAMLから読み込んだデータを格納
      const GACHA_FOLDER = 'gacha1'; // 対象のガチャフォルダ名
      let capsuleTemplate = ''; // Template string for capsule SVG

      const CAPSULE_COLORS = ['#FF5252', '#448AFF', '#FFEB3B', '#66BB6A', '#AB47BC', '#FF9800', '#00BCD4'];

      // ==========================================
      // Adapter for Local/Container Execution
      // ==========================================
      const isGasEnvironment = (typeof google !== 'undefined' && google.script && google.script.run);

      const backend = isGasEnvironment ? google.script.run : {
        withSuccessHandler: function(success) {
            const runner = Object.create(this);
            runner._success = success;
            return runner;
        },
        withFailureHandler: function(failure) {
            const runner = Object.create(this);
            runner._failure = failure;
            return runner;
        },
        getGachaData: function(folder) {
            fetch(`/api/getGachaData?folder=${folder}`)
                .then(r => r.json())
                .then(data => this._success && this._success(data))
                .catch(err => this._failure && this._failure(err));
        },
        getItemAsset: function(folder, img, desc) {
            fetch(`/api/getItemAsset?folder=${folder}&image=${img}&description=${desc}`)
                .then(r => r.json())
                .then(data => this._success && this._success(data))
                .catch(err => this._failure && this._failure(err));
        },
        getCommonAsset: function(filename) {
            // Local assumes gacha_data is served under root or similar path,
            // but based on setup, we can access via 'gacha_data/...' if served static.
            // Since server.js serves '..', 'gacha_data' is accessible.
            fetch(`gacha_data/${filename}`)
                .then(r => {
                    if (!r.ok) throw new Error('File not found');
                    return r.text();
                })
                .then(text => this._success && this._success({ success: true, content: text }))
                .catch(err => this._failure && this._failure(err));
        }
      };

      // 初期化：ページ読み込み時にYAMLとリソースを取得
      window.onload = function() {
        loadResources();
      };

      function loadResources() {
          // Load Items
          backend
            .withSuccessHandler(onDataLoaded)
            .withFailureHandler(onError)
            .getGachaData(GACHA_FOLDER);

          // Load Machine SVG
          backend
            .withSuccessHandler((res) => {
                if(res.success) {
                    document.getElementById('machine-container').innerHTML = res.content;
                    // Ensure the injected SVG has the id 'machine' if not already
                    const svg = document.querySelector('#machine-container svg');
                    if(svg) {
                        svg.id = 'machine';
                        svg.classList.add('w-full', 'h-full');
                    }
                }
            })
            .getCommonAsset('machine.svg');

          // Load Capsule SVG Template
          backend
            .withSuccessHandler((res) => {
                if(res.success) {
                    capsuleTemplate = res.content;
                    // Initial render hidden
                    document.getElementById('capsule').innerHTML = capsuleTemplate;
                }
            })
            .getCommonAsset('capsule.svg');
      }

      function onDataLoaded(res) {
        if (res.success) {
          // js-yamlを使ってテキストをオブジェクトに変換
          gachaItems = jsyaml.load(res.yaml);
          console.log("Loaded Items:", gachaItems);
          // 読み込み成功時にボタンを有効化
          document.getElementById('btn-pull').disabled = false;
        } else {
          alert("データの読み込みに失敗しました: " + res.error);
        }
      }

      async function pullGacha() {
        if (gachaItems.length === 0) return;

        const btn = document.getElementById('btn-pull');
        const machine = document.getElementById('machine');
        const capsuleContainer = document.getElementById('capsule');
        const smoke = document.getElementById('smoke');
        
        // UI初期化
        btn.disabled = true;
        document.getElementById('result-area').classList.remove('hidden');
        document.getElementById('result-content').classList.add('hidden');
        document.getElementById('loading').classList.remove('hidden');
        smoke.classList.remove('smoke-pop');

        // 1. Prepare Capsule Color
        const randomColor = CAPSULE_COLORS[Math.floor(Math.random() * CAPSULE_COLORS.length)];

        // Re-inject capsule with new color or update existing
        if (capsuleTemplate) {
            capsuleContainer.innerHTML = capsuleTemplate;
            const capsuleColorEl = capsuleContainer.querySelector('.capsule-color');
            if(capsuleColorEl) {
                capsuleColorEl.setAttribute('fill', randomColor);
                // Also update stroke if needed, but fill is main
            }
        }

        // 2. Start Animations
        if(machine) {
            machine.classList.add('animate-shake');
            const handle = machine.querySelector('#machine-handle');
            if(handle) {
                handle.classList.remove('animate-spin-handle'); // Reset
                void handle.offsetWidth; // Trigger reflow
                handle.classList.add('animate-spin-handle');
            }
        }

        capsuleContainer.classList.add('capsule-appear');

        // 抽選ロジック
        const item = drawItem();

        try {
            // アニメーション完了待機 (2秒) と データ取得 を並行実行
            const [assets] = await Promise.all([
                fetchItemAsset(item),
                wait(2000) // アニメーション時間
            ]);

            // アニメーション・データ取得完了後
            if(machine) machine.classList.remove('animate-shake');
            capsuleContainer.classList.remove('capsule-appear');
            smoke.classList.add('smoke-pop'); // 煙ポンッ

            // 少し遅らせて結果表示
            setTimeout(() => {
                showResult(item, assets);
            }, 300);

        } catch (e) {
            onError(e);
        }
      }

      function wait(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
      }

      function fetchItemAsset(item) {
          return new Promise((resolve, reject) => {
             backend
              .withSuccessHandler((assets) => resolve(assets))
              .withFailureHandler((err) => reject(err))
              .getItemAsset(GACHA_FOLDER, item.image, item.description);
          });
      }

      function drawItem() {
        // 重み付け抽選の簡易実装
        const totalWeight = gachaItems.reduce((sum, item) => sum + (item.weight || 1), 0);
        let random = Math.random() * totalWeight;
        
        for (const item of gachaItems) {
          random -= (item.weight || 1);
          if (random < 0) return item;
        }
        return gachaItems[0];
      }

      function showResult(item, assets) {
        document.getElementById('loading').classList.add('hidden');
        
        if (assets.success) {
          const content = document.getElementById('result-content');
          content.classList.remove('hidden');

          document.getElementById('item-name').innerText = item.name;
          document.getElementById('item-img').src = assets.imageData;
          // markedを使ってMarkdownをHTMLに変換
          document.getElementById('item-desc').innerHTML = marked.parse(assets.mdContent);
        } else {
          alert('景品の取得に失敗しました');
        }
        
        const btn = document.getElementById('btn-pull');
        btn.disabled = false;
        btn.innerText = "もう一度回す";
      }

      function onError(e) {
        alert('エラーが発生しました: ' + e);
        document.getElementById('btn-pull').disabled = false;
        const machine = document.getElementById('machine');
        if(machine) machine.classList.remove('animate-shake');
        document.getElementById('capsule').classList.remove('capsule-appear');
      }
    </script>
  </body>
</html>
