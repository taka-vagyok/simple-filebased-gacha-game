<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <base target="_top">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
      /* ã‚¬ãƒãƒ£æ¼”å‡ºç”¨CSS */
      @keyframes shake {
        0% { transform: rotate(0deg); }
        25% { transform: rotate(5deg); }
        50% { transform: rotate(0deg); }
        75% { transform: rotate(-5deg); }
        100% { transform: rotate(0deg); }
      }
      .animate-shake { animation: shake 0.5s infinite; }
      
      .capsule {
        transition: transform 1s;
      }
      .capsule.open {
        transform: scale(0);
      }
    </style>
  </head>
  <body class="bg-yellow-50 min-h-screen flex flex-col items-center justify-center p-4">

    <div id="app" class="max-w-md w-full bg-white rounded-xl shadow-lg overflow-hidden p-6 text-center">
      <h1 class="text-2xl font-bold text-gray-800 mb-6">ãŠæ¥½ã—ã¿ã‚¬ãƒãƒ£</h1>

      <div id="machine" class="mb-8 text-6xl cursor-pointer select-none">
        ğŸ
      </div>

      <button id="btn-pull" onclick="pullGacha()" disabled class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-full shadow-lg transition transform active:scale-95 disabled:opacity-50">
        ã‚¬ãƒãƒ£ã‚’å›ã™ï¼
      </button>

      <div id="result-area" class="hidden mt-6 border-t pt-6">
        <div id="loading" class="hidden text-gray-500">ã‚«ãƒ—ã‚»ãƒ«ã‚’é–‹ã‘ã¦ã„ã¾ã™...</div>
        
        <div id="result-content" class="hidden">
          <h2 id="item-name" class="text-xl font-bold text-purple-600 mb-2"></h2>
          <img id="item-img" class="w-full h-48 object-contain mb-4 rounded-md bg-gray-100" />
          <div id="item-desc" class="text-left text-gray-700 text-sm bg-gray-50 p-3 rounded markdown-body"></div>
        </div>
      </div>
    </div>

    <script>
      let gachaItems = []; // YAMLã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´
      const GACHA_FOLDER = 'gacha1'; // å¯¾è±¡ã®ã‚¬ãƒãƒ£ãƒ•ã‚©ãƒ«ãƒ€å

      // åˆæœŸåŒ–ï¼šãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«YAMLã‚’å–å¾—
      window.onload = function() {
        google.script.run
          .withSuccessHandler(onDataLoaded)
          .withFailureHandler(onError)
          .getGachaData(GACHA_FOLDER);
      };

      function onDataLoaded(res) {
        if (res.success) {
          // js-yamlã‚’ä½¿ã£ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
          gachaItems = jsyaml.load(res.yaml);
          console.log("Loaded Items:", gachaItems);
          // èª­ã¿è¾¼ã¿æˆåŠŸæ™‚ã«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
          document.getElementById('btn-pull').disabled = false;
        } else {
          alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + res.error);
        }
      }

      function pullGacha() {
        if (gachaItems.length === 0) return;

        const btn = document.getElementById('btn-pull');
        const machine = document.getElementById('machine');
        
        // æ¼”å‡ºé–‹å§‹
        btn.disabled = true;
        machine.classList.add('animate-shake');
        document.getElementById('result-area').classList.remove('hidden');
        document.getElementById('result-content').classList.add('hidden');
        document.getElementById('loading').classList.remove('hidden');

        // æŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯ (é‡ã¿ä»˜ã‘æŠ½é¸)
        const item = drawItem();

        // GASã¸ç”»åƒã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’å–ã‚Šã«è¡Œã
        google.script.run
          .withSuccessHandler((assets) => showResult(item, assets))
          .withFailureHandler(onError)
          .getItemAsset(GACHA_FOLDER, item.image, item.description);
      }

      function drawItem() {
        // é‡ã¿ä»˜ã‘æŠ½é¸ã®ç°¡æ˜“å®Ÿè£…
        const totalWeight = gachaItems.reduce((sum, item) => sum + (item.weight || 1), 0);
        let random = Math.random() * totalWeight;
        
        for (const item of gachaItems) {
          random -= (item.weight || 1);
          if (random < 0) return item;
        }
        return gachaItems[0];
      }

      function showResult(item, assets) {
        const machine = document.getElementById('machine');
        const btn = document.getElementById('btn-pull');
        
        machine.classList.remove('animate-shake');
        document.getElementById('loading').classList.add('hidden');
        
        if (assets.success) {
          const content = document.getElementById('result-content');
          content.classList.remove('hidden');

          document.getElementById('item-name').innerText = item.name;
          document.getElementById('item-img').src = assets.imageData;
          // markedã‚’ä½¿ã£ã¦Markdownã‚’HTMLã«å¤‰æ›
          document.getElementById('item-desc').innerHTML = marked.parse(assets.mdContent);
        } else {
          alert('æ™¯å“ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        btn.disabled = false;
        btn.innerText = "ã‚‚ã†ä¸€åº¦å›ã™";
      }

      function onError(e) {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e);
        document.getElementById('btn-pull').disabled = false;
        document.getElementById('machine').classList.remove('animate-shake');
      }
    </script>
  </body>
</html>
